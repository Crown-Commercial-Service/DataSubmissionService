language: ruby
rvm:
- 2.5.5
services:
  - postgresql
addons:
  postgresql: "10"
apt:
  packages:
  - postgresql-10
  - postgresql-client-10
dist: xenial
cache:
  - bundler
env:
  - API_ROOT='https://ccs.api/'
  global:
    - CF_USER=systems-gpass@dxw.com
    - CF_ORG=ccs-report-management-info
      secure: "f56M3wNsUuUH3tWzTyAsUoUKGhjYMWLAukDKuBn2n75foheWnMeJWUwOKpfEPLa64oOX5mx5oOvCuocaYkK/wvfrRQT4Xi8k370CSGNacVtZCrBYKpjRpuIpgRMSJJW6zFiqoT96V2GsZ1sAcsUn4GWDcvBDUTN7oRzkvu/R8pjMupohlBsAFgqm9tkgfMafn/DyWxAr2meUWu8P5p/6fxa5MOtE27Dj/E98NxAUBK3m41t96x9MRFUeaEAYPx6TzWFHpCDrJoHY20h5jQXeefb/jtaE2iJtT0Yhr/Jyven6ReAxNClzwD5OhPs9LOuslgRFIoNWActgDXSl9rgPtBSkCfbLJLZv0F009TO4y1/KFA10dykYxA3oJqnexlelRQTESzzYme86ixxjT1S5E8gpNNWWVN3JdlwjZA2C45GyV3sIO/mY91JyeyOFWytTOUhi4BEooEcsePvm9a/ixtGTtKQdtlK/tpiv5ILP0srFe6Cm1WVhYkHfPAQ11Ua+1CeKJhLSfSg57XFNl4Mv9M8kPeA3/0lhA0AiILh35XzDdqRoqzPLmLqIhI07HFWc/A5FkBJ+NyVIFaOyWl98ejTgl27fU7/qZS6OjxmYCIF1wNuKMMdYCsMSGkMN242yLJpnpqXWOl8EGZzfkD8VvrBxwQRXC5PO3e2jYnQHaVU="
before_script:
  - bundle exec bin/rails db:migrate RAILS_ENV=test
  - bundle exec rake AWS_ACCESS_KEY_ID=dummy AWS_SECRET_ACCESS_KEY=dummy AWS_S3_REGION=dummy AWS_S3_BUCKET=dummy SECRET_KEY_BASE=dummy DATABASE_URL=postgresql:does_not_exist --quiet assets:precompile
before_deploy: echo "install cloudfoundry cli"
deploy:
  provider: script
  script: bash CF/deploy-app.sh -u $CF_USER -o $CF_ORG -p $CF_PASS -s heroku-test
  on:
    branch: deploy-from-heroku
